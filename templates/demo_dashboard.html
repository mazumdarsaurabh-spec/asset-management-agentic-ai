<!DOCTYPE html>
<html>
<head>
    <title>Supply Chain Demo - Real-Time Updates</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes highlight {
            0%, 100% { background-color: transparent; }
            50% { background-color: #86efac; }
        }
        .highlight { animation: highlight 1s ease-in-out; }
        
        @keyframes countUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: #16a34a; }
            100% { transform: scale(1); }
        }
        .count-change { animation: countUp 0.5s ease-in-out; }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 min-h-screen text-white">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-gray-800/50 backdrop-blur rounded-lg p-6 mb-6 border border-blue-500/20">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2">ðŸš€ Supply Chain Agent System</h1>
                    <p class="text-gray-400">Real-Time Multi-Agent Optimization Platform</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-2 justify-end mb-2">
                        <div id="statusDot" class="w-4 h-4 rounded-full bg-green-500 pulse-dot"></div>
                        <span class="text-lg font-semibold">LIVE</span>
                    </div>
                    <div id="timestamp" class="text-sm text-gray-400"></div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex gap-3 flex-wrap items-center">
                <button onclick="runFullDemo()" class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-semibold hover:from-green-700 hover:to-green-800 shadow-lg">
                    ðŸŽ¬ Run Full Demo Cycle
                </button>
                <button onclick="simulateTransaction()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800">
                    ðŸ’« Simulate Transaction
                </button>
                <button onclick="runAgentCycle()" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700">
                    ðŸ¤– Run Agent Cycle
                </button>
                <div class="flex-1"></div>
                <div id="status" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg font-medium"></div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-4 gap-6 mb-6">
            <div id="metric1" class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-6 shadow-lg">
                <div class="text-blue-200 text-sm mb-2">Total Inventory</div>
                <div id="totalInventory" class="text-4xl font-bold">0</div>
            </div>
            <div id="metric2" class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-6 shadow-lg">
                <div class="text-purple-200 text-sm mb-2">Transactions</div>
                <div id="totalTransactions" class="text-4xl font-bold">0</div>
            </div>
            <div id="metric3" class="bg-gradient-to-br from-green-600 to-green-700 rounded-lg p-6 shadow-lg">
                <div class="text-green-200 text-sm mb-2">Utilization Rate</div>
                <div id="utilization" class="text-4xl font-bold">0%</div>
            </div>
            <div id="metric4" class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-lg p-6 shadow-lg">
                <div class="text-orange-200 text-sm mb-2">Active Alerts</div>
                <div id="alerts" class="text-4xl font-bold">0</div>
            </div>
        </div>

        <!-- Network Nodes -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ðŸ“¦ Network Nodes - Live Status</h2>
            <div id="nodes" class="grid grid-cols-3 gap-4"></div>
        </div>

        <!-- Agent Activity Stream -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ðŸ¤– Agent Activity Stream</h2>
            <div id="activityStream" class="space-y-2 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:8000/api';
        let previousData = {};
        let transactionCount = 0;
        let activityLog = [];
        
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
        }
        
        function setStatus(msg, color = 'blue') {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `px-4 py-2 bg-${color}-100 text-${color}-800 rounded-lg font-medium`;
        }
        
        function addActivity(agent, action, urgency = 'MEDIUM') {
            const colors = {
                'CRITICAL': 'border-red-500 bg-red-50',
                'HIGH': 'border-orange-500 bg-orange-50',
                'MEDIUM': 'border-blue-500 bg-blue-50',
                'LOW': 'border-green-500 bg-green-50'
            };
            
            const badges = {
                'CRITICAL': 'bg-red-600 text-white',
                'HIGH': 'bg-orange-600 text-white',
                'MEDIUM': 'bg-blue-600 text-white',
                'LOW': 'bg-green-600 text-white'
            };
            
            const time = new Date().toLocaleTimeString();
            const activity = `
                <div class="border-l-4 ${colors[urgency]} p-4 rounded animate-slide-in">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">ðŸ¤–</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-gray-800">${agent}</span>
                                <span class="px-2 py-1 text-xs rounded ${badges[urgency]}">${urgency}</span>
                            </div>
                            <p class="text-sm text-gray-700">${action}</p>
                        </div>
                        <span class="text-xs text-gray-500">${time}</span>
                    </div>
                </div>
            `;
            
            const stream = document.getElementById('activityStream');
            stream.innerHTML = activity + stream.innerHTML;
            
            // Keep only last 10 activities
            const items = stream.children;
            if (items.length > 10) {
                stream.removeChild(items[items.length - 1]);
            }
        }
        
        async function loadData() {
            try {
                const [nodesRes, summaryRes] = await Promise.all([
                    fetch(`${API}/nodes/`),
                    fetch(`${API}/nodes/network_summary/`)
                ]);
                
                const nodesData = await nodesRes.json();
                const summary = await summaryRes.json();
                const nodes = nodesData.results || nodesData;
                
                // Animate metric changes
                animateValue('totalInventory', summary.total_inventory);
                animateValue('utilization', summary.utilization_rate.toFixed(1), '%');
                
                // Update nodes
                document.getElementById('nodes').innerHTML = nodes.map(node => {
                    const ratio = node.current_inventory / node.inventory_capacity;
                    const oldNode = previousData[node.id];
                    const changed = oldNode && oldNode !== node.current_inventory;
                    const diff = oldNode ? node.current_inventory - oldNode : 0;
                    
                    let color = 'bg-red-500';
                    if (ratio >= 0.6) color = 'bg-green-500';
                    else if (ratio >= 0.3) color = 'bg-yellow-500';
                    
                    previousData[node.id] = node.current_inventory;
                    
                    return `
                        <div class="border-2 rounded-lg p-4 ${changed ? 'highlight' : ''} bg-gray-50">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="font-bold text-gray-800">${node.name}</div>
                                    <div class="text-xs text-gray-500">${node.node_type}</div>
                                </div>
                                <span class="px-2 py-1 bg-blue-600 text-white text-xs rounded font-mono">${node.code}</span>
                            </div>
                            <div class="mb-2">
                                <div class="flex justify-between items-baseline">
                                    <span class="text-2xl font-bold text-gray-800 ${changed ? 'count-change' : ''}">${node.current_inventory.toLocaleString()}</span>
                                    ${changed && diff !== 0 ? `<span class="text-sm font-bold ${diff > 0 ? 'text-green-600' : 'text-red-600'}">${diff > 0 ? 'â–²' : 'â–¼'} ${Math.abs(diff)}</span>` : ''}
                                </div>
                                <div class="text-xs text-gray-500">/ ${node.inventory_capacity.toLocaleString()}</div>
                            </div>
                            <div class="w-full bg-gray-300 rounded-full h-3">
                                <div class="${color} h-3 rounded-full transition-all duration-1000" style="width: ${ratio * 100}%"></div>
                            </div>
                            <div class="text-right mt-1">
                                <span class="text-sm font-semibold text-gray-700">${(ratio * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                updateTimestamp();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        function animateValue(elementId, value, suffix = '') {
            const el = document.getElementById(elementId);
            const current = parseInt(el.textContent) || 0;
            const target = typeof value === 'number' ? value : parseInt(value);
            
            if (current === target) return;
            
            el.classList.add('count-change');
            setTimeout(() => el.classList.remove('count-change'), 500);
            
            const duration = 1000;
            const steps = 30;
            const stepValue = (target - current) / steps;
            const stepTime = duration / steps;
            
            let step = 0;
            const interval = setInterval(() => {
                step++;
                const newValue = Math.round(current + (stepValue * step));
                el.textContent = newValue.toLocaleString() + suffix;
                
                if (step >= steps) {
                    clearInterval(interval);
                    el.textContent = target.toLocaleString() + suffix;
                }
            }, stepTime);
        }
        
        async function simulateTransaction() {
            setStatus('âš¡ Simulating transaction...', 'yellow');
            
            try {
                const res = await fetch(`${API}/nodes/`);
                const data = await res.json();
                const nodes = data.results || data;
                
                // Pick two random nodes
                const fromNode = nodes[Math.floor(Math.random() * nodes.length)];
                const toNode = nodes.filter(n => n.id !== fromNode.id)[Math.floor(Math.random() * (nodes.length - 1))];
                
                const amount = Math.floor(Math.random() * 500) + 100;
                
                // Update from node (decrease)
                await fetch(`${API}/nodes/${fromNode.id}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_inventory: Math.max(0, fromNode.current_inventory - amount)
                    })
                });
                
                // Update to node (increase)
                await fetch(`${API}/nodes/${toNode.id}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_inventory: Math.min(toNode.current_inventory + amount, toNode.inventory_capacity)
                    })
                });
                
                transactionCount++;
                document.getElementById('totalTransactions').textContent = transactionCount;
                document.getElementById('metric2').classList.add('highlight');
                setTimeout(() => document.getElementById('metric2').classList.remove('highlight'), 1000);
                
                addActivity('TransportationAgent', `Moved ${amount} units: ${fromNode.code} â†’ ${toNode.code}`, 'HIGH');
                setStatus(`âœ“ Transaction complete: ${amount} units moved`, 'green');
                
                setTimeout(loadData, 500);
                
            } catch (error) {
                setStatus('âœ— Transaction failed', 'red');
                console.error(error);
            }
        }
        
        async function runAgentCycle() {
            setStatus('ðŸ¤– Running agent cycle...', 'purple');
            
            try {
                const res = await fetch(`${API}/decisions/run_agent_cycle/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    const r = data.results;
                    addActivity('CoordinatorAgent', `Cycle complete: ${r.inventory_decisions} inventory, ${r.transport_decisions} transport, ${r.service_alerts} alerts`, 'MEDIUM');
                    
                    const alerts = r.service_alerts || 0;
                    document.getElementById('alerts').textContent = alerts;
                    if (alerts > 0) {
                        document.getElementById('metric4').classList.add('highlight');
                        setTimeout(() => document.getElementById('metric4').classList.remove('highlight'), 1000);
                    }
                    
                    setStatus(`âœ“ Agent cycle complete`, 'green');
                    setTimeout(loadData, 500);
                }
            } catch (error) {
                setStatus('âœ— Agent cycle failed', 'red');
                console.error(error);
            }
        }
        
        async function runFullDemo() {
            setStatus('ðŸŽ¬ Running full demo sequence...', 'blue');
            addActivity('SystemCoordinator', 'Starting automated demo sequence...', 'HIGH');
            
            // Step 1: Initialize
            await fetch(`${API}/nodes/initialize_network/`, { method: 'POST' });
            await loadData();
            await new Promise(r => setTimeout(r, 1500));
            
            // Step 2: Run 3 transactions
            for (let i = 0; i < 3; i++) {
                await simulateTransaction();
                await new Promise(r => setTimeout(r, 2000));
            }
            
            // Step 3: Run agent cycle
            await runAgentCycle();
            await new Promise(r => setTimeout(r, 1500));
            
            // Step 4: More transactions
            for (let i = 0; i < 2; i++) {
                await simulateTransaction();
                await new Promise(r => setTimeout(r, 2000));
            }
            
            setStatus('âœ“ Demo sequence complete!', 'green');
            addActivity('SystemCoordinator', 'âœ“ Demo sequence completed successfully', 'LOW');
        }
        
        // Auto-refresh
        setInterval(loadData, 3000);
        
        // Initial load
        loadData();
        setStatus('System ready', 'green');
    </script>
</body>
</html>