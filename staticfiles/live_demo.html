<!DOCTYPE html>
<html>
<head>
    <title>Supply Chain Live Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="utf-8" />
    <style>
        /* --- Glow highlight for step demo --- */
        .glow-highlight {
            animation: glowPulse 1.5s infinite;
            box-shadow: 0 0 25px 8px rgba(59,130,246,0.8) !important;
            border: 3px solid rgba(59,130,246,1) !important;
            border-radius: 12px;
            transition: box-shadow .3s, transform .2s;
            transform-origin: center;
        }

        @keyframes glowPulse {
            0% { box-shadow: 0 0 10px rgba(59,130,246,0.35); transform: translateY(0); }
            50% { box-shadow: 0 0 40px rgba(59,130,246,0.95); transform: translateY(-3px); }
            100% { box-shadow: 0 0 10px rgba(59,130,246,0.35); transform: translateY(0); }
        }

        body { margin: 0; overflow: auto; font-family: Inter, ui-sans-serif, system-ui; background: linear-gradient(180deg,#0f172a 0%, #08203a 100%); color: #e6eef8; }

        /* small helpers */
        .pulse-dot { animation: pulse 1.8s ease-in-out infinite; }
        @keyframes pulse { 0%,100% { opacity: 1 } 50% { opacity: 0.45 } }

        .slide-in { animation: slide-in 0.35s ease-out; }
        @keyframes slide-in { from { transform: translateX(-12px); opacity: 0 } to { transform: translateX(0); opacity: 1 } }

        .alert-pulse { animation: alertPulse 1.6s linear infinite; }
        @keyframes alertPulse { 0% { box-shadow: 0 0 4px rgba(255,70,70,0.2) } 50% { box-shadow: 0 0 16px rgba(255,70,70,0.45) } 100% { box-shadow: 0 0 4px rgba(255,70,70,0.2) } }

        /* demo overlay - resizable and draggable */
        .demo-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 480px;
            height: 520px;
            max-height: calc(100vh - 40px);
            background: white;
            border-radius: 12px;
            resize: both;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            z-index: 1100;
            border: 3px solid #3b82f6;
            color: #0f172a;
        }

        .demo-overlay .header { background: linear-gradient(90deg,#2563eb,#7c3aed); color: white; padding: 14px; border-top-left-radius: 8px; border-top-right-radius: 8px; display:flex; align-items:center; justify-content:space-between; }
        .demo-overlay .content { padding: 14px; }

        /* transport chart */
        .mini-chart { display:flex; gap:12px; align-items:end; height:84px; padding:10px; }
        .mini-chart .bar { width: 36px; border-radius:6px 6px 0 0; display:flex; align-items:flex-end; justify-content:center; color:white; font-size:12px; font-weight:700; transition: height 800ms ease-out; }
        .mini-chart .label { text-align:center; font-size:12px; color:#374151; margin-top:6px; }

        /* bottom-right Alerts & Forecast panel (Option A) */
        .alerts-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 320px;
            z-index: 1200;
            background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98));
            color: #061024;
            box-shadow: 0 12px 40px rgba(3,7,18,0.6);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(8,145,255,0.08);
        }
        .alerts-panel .head { padding:10px 12px; background: linear-gradient(90deg,#ef4444,#fb923c); color:white; display:flex; justify-content:space-between; align-items:center; }
        .alerts-panel .head .title { font-weight:700; }
        .alerts-panel .body { padding:12px; font-size:13px; color:#08304a; background: linear-gradient(180deg,#ffffff,#f7fbff); }
        .alerts-panel .alert-item { margin-bottom:10px; padding:8px; border-radius:8px; background:#fff7f7; border:1px solid rgba(255,90,90,0.06); }
        .alerts-panel .forecast { margin-top:8px; padding:8px; border-radius:8px; background:#f7fbff; border:1px solid rgba(59,130,246,0.06); }

        /* dashboard container spacing */
        .container { padding: 28px 40px; max-width:1200px; margin:0 auto; }

        /* small badges */
        .badge { font-size:12px; padding:6px 8px; border-radius:8px; font-weight:600; display:inline-block; }

        /* metric boxes in top area - keep consistent visual */
        .metrics-grid { display:grid; grid-template-columns: repeat(6, 1fr); gap:16px; margin-bottom:18px; align-items:stretch; }
        .metric-card { padding:18px; border-radius:12px; box-shadow: 0 6px 24px rgba(2,6,23,0.45); color:white; min-height:90px; display:flex; flex-direction:column; justify-content:space-between; }
        .metric-title { font-size:13px; opacity:0.9; }
        .metric-value { font-size:24px; font-weight:800; }

        /* nodes grid */
        .nodes-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
        .node-card { background: #f8fafc; color:#0f172a; border-radius:10px; padding:12px; border:1px solid rgba(2,6,23,0.06); min-height:120px; }

        /* activity stream */
        .activity-stream { max-height:320px; overflow:auto; padding:12px; background: #ffffff; border-radius:8px; color:#0b1720; }

        /* small util */
        .muted { color:#5b6b75; font-size:13px; }

        /* currency style */
        .currency { font-weight:800; }
    </style>
</head>
<body>

    <!-- Live Demo Overlay -->
    <div id="demoOverlay" class="demo-overlay" style="display:none;">
        <div class="header">
            <div style="display:flex;align-items:center; gap:10px;">
                <div class="w-3 h-3 rounded-full" style="background:#fff; box-shadow:0 0 6px rgba(255,255,255,0.6)"></div>
                <div style="font-weight:800; font-size:15px;">LIVE DEMO MODE</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button onclick="toggleDemoSize()" title="Expand" style="background:transparent;border:none;color:white;font-size:14px;">‚§¢</button>
                <button onclick="closeDemo()" title="Close" style="background:transparent;border:none;color:white;font-size:18px;">‚úï</button>
            </div>
        </div>

        <div class="content">
            <!-- slides -->
            <div id="stepDemoSlides" class="">
                <div style="font-weight:800; color:#0f172a; margin-bottom:10px;">üéØ Agentic Supply Chain Demo</div>

                <div id="slideContent" class="bg-white p-3 rounded shadow-sm" style="min-height:96px;"></div>

                <!-- mini chart -->
                <div id="transportChartWrap" style="margin-top:12px;">
                    <div style="font-size:12px; color:#334155; font-weight:700; margin-bottom:6px;">Transport Cost Comparison</div>
                    <div class="mini-chart" id="miniChart">
                        <!-- bars injected by JS -->
                    </div>
                    <div style="display:flex; gap:18px; justify-content:space-between; margin-top:6px;">
                        <div class="muted" style="font-size:12px;">WH1 ‚Üí STORE1</div>
                        <div class="muted" style="font-size:12px;">DC1 ‚Üí STORE1</div>
                        <div class="muted" style="font-size:12px;">STORE2 ‚Üí STORE1</div>
                    </div>
                </div>

                <div style="display:flex; gap:8px; justify-content:space-between; margin-top:12px;">
                    <button id="prevSlideBtn" onclick="prevSlide()" class="px-3 py-1 bg-gray-100 rounded text-sm">‚¨Ö Prev</button>
                    <div style="display:flex; gap:8px;">
                        <div id="transportCostSmall" class="badge" style="background:#eef2ff; color:#312e81;">Transport: <span class="currency" id="overlayTransportCost">$0</span></div>
                        <div id="serviceCostSmall" class="badge" style="background:#fff0f6; color:#9f1239;">Service: <span class="currency" id="overlayServiceCost">$0</span></div>
                        <button id="nextSlideBtn" onclick="nextSlide()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Next ‚û°</button>
                    </div>
                </div>
            </div>

            <!-- demo info blocks -->
            <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div style="background:#f1f5f9; padding:8px; border-radius:8px;">
                    <div style="font-weight:700; color:#0f172a;">üìä Current Operation</div>
                    <div id="demoStatus" class="muted">Waiting for action...</div>
                </div>
                <div style="background:#f8fafc; padding:8px; border-radius:8px;">
                    <div style="font-weight:700; color:#0f172a;">üéØ Active Node</div>
                    <div id="demoNode" class="muted">No node selected</div>
                </div>
            </div>

            <div style="margin-top:10px; display:flex; gap:10px;">
                <div style="flex:1; background:#fff; padding:8px; border-radius:8px;">
                    <div style="font-weight:700; color:#0f172a;">üìù Recent Activity</div>
                    <div id="demoActivity" class="muted" style="max-height:100px; overflow:auto;"></div>
                </div>
                <div style="flex:1; background:#fff; padding:8px; border-radius:8px;">
                    <div style="font-weight:700; color:#0f172a;">üìà Live Metrics</div>
                    <div id="demoMetrics" class="muted"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts & Forecast Panel (Option A - bottom-right fixed) -->
    <div class="alerts-panel" id="alertsPanel" style="display:none;">
        <div class="head">
            <div class="title">‚ö† Active Alerts</div>
            <div id="alertsCountBadge" class="badge" style="background:rgba(0,0,0,0.12); color:white;">0</div>
        </div>
        <div class="body">
            <div id="alertsList"></div>

            <div class="forecast" id="forecastBlock" style="margin-top:10px;">
                <div style="font-weight:700; margin-bottom:6px;">üîÆ Forecast & Planning</div>
                <div id="forecastText" style="font-size:13px; color:#0b3a54;">No forecasts yet</div>
                <div id="planText" style="font-size:13px; color:#0b3a54; margin-top:6px;"></div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (container) -->
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <div>
                <h1 style="font-size:28px; margin:0; font-weight:900;">üöÄ Supply Chain Agent System</h1>
                <div class="muted" style="margin-top:4px;">Real-Time Multi-Agent Optimization Platform</div>
            </div>
            <div style="text-align:right;">
                <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end;">
                    <div id="statusDot" style="width:12px; height:12px; border-radius:999px; background:#10b981; box-shadow:0 0 8px rgba(16,185,129,0.6)"></div>
                    <div id="timestamp" class="muted"></div>
                </div>
            </div>
        </div>

        <!-- controls -->
        <div style="background:rgba(255,255,255,0.03); padding:14px; border-radius:10px; margin-bottom:14px;">
            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="startLiveMode()" class="px-4 py-2 bg-red-600 text-white rounded">üî¥ LIVE Mode</button>
                <button onclick="startStepDemo()" class="px-4 py-2 bg-blue-600 text-white rounded">üé¨ Step Demo Mode</button>
                <button onclick="simulateTransaction()" class="px-4 py-2 bg-green-600 text-white rounded">üí´ Simulate Transaction</button>
                <button onclick="runAgentCycle()" class="px-4 py-2 bg-purple-600 text-white rounded">ü§ñ Run Agent Cycle</button>
                <button onclick="stopLiveMode()" class="px-4 py-2 bg-gray-600 text-white rounded">‚è∏ Stop</button>
                <div style="flex:1"></div>
                <div id="status" class="muted" style="background:rgba(255,255,255,0.02); padding:8px 12px; border-radius:8px;"></div>
            </div>
        </div>

        <!-- metrics -->
        <div class="metrics-grid" style="margin-bottom:18px;">
            <div id="metric1" class="metric-card" style="background:linear-gradient(180deg,#2563eb,#1e40af);">
                <div class="metric-title">Total Inventory</div>
                <div id="totalInventory" class="metric-value">0</div>
            </div>
            <div id="metric2" class="metric-card" style="background:linear-gradient(180deg,#7c3aed,#6d28d9);">
                <div class="metric-title">Transactions</div>
                <div id="totalTransactions" class="metric-value">0</div>
            </div>
            <div id="metric3" class="metric-card" style="background:linear-gradient(180deg,#16a34a,#047857);">
                <div class="metric-title">Utilization Rate</div>
                <div id="utilization" class="metric-value">0%</div>
            </div>
            <div id="metric4" class="metric-card" style="background:linear-gradient(180deg,#f97316,#ea580c);">
                <div class="metric-title">Active Alerts</div>
                <div id="alerts" class="metric-value">0</div>
            </div>

            <!-- new cost metrics -->
            <div id="metric5" class="metric-card" style="background:linear-gradient(180deg,#4f46e5,#4338ca);">
                <div class="metric-title">Total Transport Cost</div>
                <div id="transportCost" class="metric-value currency">$0</div>
            </div>
            <div id="metric6" class="metric-card" style="background:linear-gradient(180deg,#db2777,#be185d);">
                <div class="metric-title">Service Level Cost</div>
                <div id="serviceCost" class="metric-value currency">$0</div>
            </div>
        </div>

        <!-- nodes -->
        <div style="margin-bottom:16px;">
            <h2 style="margin:0 0 8px 0;">üì¶ Network Nodes - Live Status</h2>
            <div id="nodes" class="nodes-grid"></div>
        </div>

        <!-- activity stream -->
        <div>
            <h2 style="margin:0 0 8px 0;">ü§ñ Agent Activity Stream</h2>
            <div id="activityStream" class="activity-stream"></div>
        </div>
    </div>

<script>
const API = '/api';            // adjust if needed
let previousData = {};
let transactionCount = 0;
let isLiveMode = false;
let liveInterval = null;
let currentSlide = 0;

/* --- Slide mapping (kept exactly as requested) --- */
const stepSlides = [
    {
        title: "1Ô∏è‚É£ Network Initialization",
        text: "The system initializes all supply chain nodes including suppliers, factories, warehouses, and hubs.",
        highlight: "nodes"
    },
    {
        title: "2Ô∏è‚É£ Inventory Monitoring",
        text: "Each node‚Äôs inventory is continuously monitored to prevent stock-outs and excess stock. (AI watches inventory, raises reorder suggestions.)",
        highlight: "metric1"
    },
    {
        title: "3Ô∏è‚É£ Capacity & Utilization Tracking",
        text: "Utilization rates help the AI detect overloaded or underutilized nodes and plan rebalancing.",
        highlight: "metric3"
    },
    {
        title: "4Ô∏è‚É£ Transportation Optimization",
        text: "The Transportation Agent compares possible sources (WH1, DC1, STORE2) to fulfill Store1 shortage, estimates per-route transport cost and chooses the cheapest option.",
        highlight: "metric5"
    },
    {
        title: "5Ô∏è‚É£ Demand Forecasting",
        text: "Agent forecasts upcoming shortages using recent demand patterns and recommends advance inventory planning to avoid stockouts.",
        highlight: "activityStream"
    },
    {
        title: "6Ô∏è‚É£ Automated Decision Making",
        text: "The Coordinator Agent triggers reorder or transport: it chooses the lowest cost transport option, or places a reorder when transfer isn't cost-effective.",
        highlight: "alerts"
    },
    {
        title: "7Ô∏è‚É£ Live Closed-Loop Optimization (AI vs Human)",
        text: "Human: Manually compare options and react slowly. \n\nAI: Evaluates transport cost + service cost and executes the best action instantly ‚Äî ensuring low cost and high service levels.",
        highlight: "status"
    }
];

/* --- utility functions --- */
function $(id){ return document.getElementById(id); }
function fmtMoney(v){ return '$' + Number(v||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
function updateTimestamp(){ const ts = $('timestamp'); if(ts) ts.textContent = new Date().toLocaleTimeString(); }

/* --- status text --- */
function setStatus(msg, color='blue'){
    const el = $('status');
    if(!el) return;
    el.textContent = msg;
    el.style.background = '';
    el.style.color = '';
}

/* --- demo overlay helpers --- */
function openOverlay(){ $('demoOverlay').style.display = 'block'; $('alertsPanel').style.display = 'block'; }
function closeDemo(){ $('demoOverlay').style.display = 'none'; /* slides UI remains hidden until opened */ clearHighlights(); }
function toggleDemoSize(){
    const box = $('demoOverlay');
    if(!box) return;
    if(box.dataset.expanded === '1'){
        box.style.width = '480px'; box.style.height = '520px'; box.dataset.expanded = '0';
    } else {
        box.style.width = '840px'; box.style.height = '80vh'; box.dataset.expanded = '1';
    }
}

/* --- draw nodes/cards --- */
async function loadData(){
    try {
        const [nodesRes, summaryRes] = await Promise.all([
            fetch(`${API}/nodes/`),
            fetch(`${API}/nodes/network_summary/`)
        ]);
        const nodesData = await nodesRes.json();
        const summary = await summaryRes.json();
        const nodes = nodesData.results || nodesData;

        // update metrics
        animateValue('totalInventory', summary.total_inventory || 0);
        animateValue('utilization', (summary.utilization_rate||0).toFixed(1) + '%');

        // transport/service cost might be stored on server; keep existing metric values
        // render nodes
        const nodesHTML = (nodes || []).map(n => {
            const ratio = (n.current_inventory / Math.max(1,n.inventory_capacity));
            let color = '#ef4444';
            if(ratio >= 0.6) color = '#16a34a';
            else if(ratio >= 0.3) color = '#f59e0b';
            return `<div data-node-id="${n.id}" class="node-card" id="node-${n.id}">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div style="font-weight:800;">${n.name}</div>
                    <div class="badge" style="background:${color}; color:white;">${n.code}</div>
                </div>
                <div class="muted" style="margin-top:6px;">${n.node_type}</div>
                <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:end;">
                    <div>
                        <div style="font-weight:800; font-size:20px;">${Number(n.current_inventory).toLocaleString()}</div>
                        <div class="muted">/ ${Number(n.inventory_capacity).toLocaleString()}</div>
                    </div>
                    <div style="width:120px;">
                        <div style="height:10px; background:#e6eef8; border-radius:6px; overflow:hidden;">
                            <div style="height:10px; width:${Math.max(0, Math.min(100, ratio*100))}%; background:${color}; transition: width 800ms ease;"></div>
                        </div>
                        <div class="muted" style="text-align:right; font-size:12px; margin-top:6px;">${(ratio*100).toFixed(1)}%</div>
                    </div>
                </div>
            </div>`;
        }).join('');
        $('nodes').innerHTML = nodesHTML;

        updateTimestamp();
    } catch(err){
        console.error('loadData error', err);
    }
}

/* animate numeric changes */
function animateValue(id, value, suffix=''){
    const el = $(id);
    if(!el) return;
    const cur = parseInt(el.textContent.replace(/[^0-9\-]/g,''))||0;
    const target = typeof value === 'number' ? value : parseFloat((value+'').replace(/[^0-9\.\-]/g,''))||0;
    if(cur === target) { el.textContent = (suffix? (target+suffix) : target.toString()); return; }
    el.classList.add('slide-in');
    setTimeout(()=>el.classList.remove('slide-in'), 400);
    // simple tween
    const duration=600, steps=30, stepVal=(target-cur)/steps, stepTime=Math.max(10,duration/steps);
    let step=0;
    const iv = setInterval(()=>{ step++; const v=Math.round(cur + stepVal*step); el.textContent = (suffix? v+suffix : v.toLocaleString()); if(step>=steps){ clearInterval(iv); el.textContent = (suffix? target+suffix : target.toLocaleString()); } }, stepTime);
}

/* clear existing highlights */
function clearHighlights(){
    document.querySelectorAll('.glow-highlight').forEach(e=>e.classList.remove('glow-highlight'));
}

/* --- step demo (click-only) --- */
function startStepDemo(){
    openOverlay();
    $('stepDemoSlides').classList.remove('hidden');
    currentSlide = 0;
    showSlide(currentSlide);
    setStatus('Step Demo Mode Running...', 'blue');
}

function showSlide(index){
    clearHighlights();
    const slide = stepSlides[index];
    if(!slide) return;
    $('slideContent').innerText = slide.text;
    $('demoStatus').textContent = slide.title;
    $('demoNode').textContent = slide.text;
    // highlight mapping element
    const targetId = slide.highlight;
    // mapping: many slide.highlight values are metric ids or nodes container
    let el = null;
    if(targetId === 'nodes') el = $('nodes');
    else el = $(targetId);
    if(el){
        el.classList.add('glow-highlight');
        // smooth scroll into view when applicable
        try{ el.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){}
    }
    // update mini chart for slide 4 (transport)
    if(index === 3) renderTransportChart([42,71,55]); // example values
    else renderTransportChart(null);
    // update overlay cost badges from last known values
    $('overlayTransportCost').textContent = $('transportCost').textContent || '$0';
    $('overlayServiceCost').textContent = $('serviceCost').textContent || '$0';
}

function nextSlide(){ if(currentSlide < stepSlides.length-1){ currentSlide++; showSlide(currentSlide);} }
function prevSlide(){ if(currentSlide > 0){ currentSlide--; showSlide(currentSlide);} }

/* --- transport comparison mini chart (simple animated bars) --- */
function renderTransportChart(costs){
    const wrap = $('miniChart');
    wrap.innerHTML = '';
    if(!costs || costs.length === 0){
        // placeholder empty bars
        for(let i=0;i<3;i++){
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.style.height = '6px';
            bar.style.background = '#c7d2fe';
            wrap.appendChild(bar);
        }
        return;
    }
    const max = Math.max(...costs,1);
    const colors = ['#4f46e5','#1d4ed8','#db2777'];
    costs.forEach((c,idx)=>{
        const pct = Math.max(6, Math.round((c/max) * 84)); // px height
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = '6px';
        bar.style.background = colors[idx%colors.length];
        bar.style.borderRadius = '8px';
        bar.style.display = 'flex';
        bar.style.flexDirection = 'column';
        // label inside top (cost)
        const label = document.createElement('div');
        label.style.fontSize = '11px';
        label.style.marginBottom = '6px';
        label.style.opacity = '0.95';
        label.textContent = fmtMoney(c);
        label.style.transform = 'translateY(-6px)';
        label.style.fontWeight = '700';
        label.style.pointerEvents = 'none';
        // wrapper: we will set height via timeout to animate
        bar.appendChild(label);
        wrap.appendChild(bar);
        // animate
        setTimeout(()=>{ bar.style.height = pct + 'px'; }, 80 + idx*80);
    });
}

/* --- highlight node by ID (glow-effect) --- */
function highlightNode(nodeId){
    document.querySelectorAll('.glow-effect').forEach(e=>e.classList.remove('glow-effect'));
    const el = document.querySelector(`[data-node-id="${nodeId}"]`);
    if(el){
        el.classList.add('glow-effect');
        el.scrollIntoView({behavior:'smooth', block:'center'});
    }
}

/* --- simulate transaction (simple demo) --- */
async function simulateTransaction(){
    setStatus('Simulating transaction...', 'yellow');
    updateDemoOverlay('Executing transaction','Moving inventory between nodes', 'Transaction initiated');
    try {
        const res = await fetch(`${API}/nodes/`);
        const data = await res.json();
        const nodes = data.results || data;
        if(!nodes || nodes.length < 2) { setStatus('Not enough nodes', 'red'); return; }
        const from = nodes[Math.floor(Math.random()*nodes.length)];
        const toCandidates = nodes.filter(n=>n.id !== from.id);
        const to = toCandidates[Math.floor(Math.random()*toCandidates.length)];
        const amount = Math.floor(Math.random()*500)+100;

        // optimistic UI: ping PATCH endpoints - if your backend expects UUID strings, use as-is
        await fetch(`${API}/nodes/${from.id}/`, {
            method:'PATCH', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ current_inventory: Math.max(0, from.current_inventory - amount)})
        });
        setTimeout(()=>highlightNode(from.id), 50);
        setTimeout(async ()=>{
            await fetch(`${API}/nodes/${to.id}/`, {
                method:'PATCH', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ current_inventory: Math.min(to.current_inventory + amount, to.inventory_capacity)})
            });
            highlightNode(to.id);
        }, 850);

        transactionCount++;
        $('totalTransactions').textContent = transactionCount;
        addActivity('TransportationAgent', `Moved ${amount} units: ${from.code} ‚Üí ${to.code}`, 'HIGH');
        updateDemoOverlay(`Transaction complete: ${amount} units moved`, `<div style="font-family:monospace; font-size:12px;">FROM: ${from.code} (${from.current_inventory} ‚Üí ${Math.max(0, from.current_inventory - amount)})<br>TO: ${to.code} (${to.current_inventory} ‚Üí ${Math.min(to.current_inventory + amount, to.inventory_capacity)})</div>`);
        setStatus('‚úì Transaction complete', 'green');
        setTimeout(loadData, 600);
    } catch(err){
        console.error(err);
        setStatus('Transaction failed','red');
    }
}

/* --- run agent cycle (calls backend, reads totals & alerts) --- */
async function runAgentCycle(){
    setStatus('Running agent cycle...','purple');
    updateDemoOverlay('Agent cycle running...', 'AI agents analyzing network', 'Agent cycle started');

    try {
        const res = await fetch(`${API}/decisions/run_agent_cycle/`, {
            method:'POST', headers:{'Content-Type':'application/json'}
        });
        const payload = await res.json();

        if(payload.status !== 'success'){
            setStatus('Agent cycle failed','red');
            console.error('run_agent_cycle failed', payload);
            return;
        }

        const results = payload.results || {};
        // update metrics for costs
        const totTransport = results.total_transport_cost || 0;
        const totService = results.total_service_level_cost || 0;
        $('transportCost').textContent = fmtMoney(totTransport);
        $('serviceCost').textContent = fmtMoney(totService);
        $('overlayTransportCost').textContent = fmtMoney(totTransport);
        $('overlayServiceCost').textContent = fmtMoney(totService);

        // update alerts count and list based on decisions (server returns saved decisions)
        const decisions = payload.decisions || [];
        const alerts = decisions.filter(d => d.decision_type === 'SERVICE_ALERT');
        const alertCount = alerts.length;
        $('alerts').textContent = alertCount;
        $('alertsCountBadge').textContent = alertCount;

        // prepare alerts list content
        const alertsList = $('alertsList');
        alertsList.innerHTML = '';
        if(alerts.length === 0 && (results.logs || []).length){
            // fallback: search logs for ALERT lines
            (results.logs || []).forEach(log => {
                if(log.toLowerCase().includes('alert') || log.toLowerCase().includes('[alert]')){
                    const item = document.createElement('div');
                    item.className = 'alert-item alert-pulse';
                    item.innerHTML = `<div style="font-weight:700;">System Alert</div><div class="muted" style="margin-top:6px;">${log}</div>`;
                    alertsList.appendChild(item);
                }
            });
        } else {
            alerts.forEach(a=>{
                const item = document.createElement('div');
                item.className = 'alert-item alert-pulse';
                const nodeName = a.destination_node ? (a.destination_node.name || a.destination_node) : (a.source_node ? a.source_node.name : 'Unknown');
                item.innerHTML = `<div style="font-weight:800; color:#b91c1c;">${a.urgency || 'CRITICAL'} - ${a.agent_name}</div>
                                  <div class="muted" style="margin-top:6px;">Node: ${a.destination_node ? (a.destination_node.name||a.destination_node) : 'N/A'}<br>${a.reason || ''}</div>`;
                alertsList.appendChild(item);
            });
        }

        // forecasting & planning: compute simple forecast heuristics for STORE nodes (client-side fallback)
        await computeForecastAndPlan();

        // transport chart: if transport decisions present, show comparison (take sample estimated_costs or compute)
        const transportDecs = payload.results.transport_decisions || 0;
        // if server returned actual decisions objects, we might use them
        if(payload.results && payload.results.logs){
            // derive sample costs - if server included detailed transport_decisions (not just count), use them
        }

        addActivity('CoordinatorAgent', `Cycle: inv=${results.inventory_decisions||0} trans=${results.transport_decisions||0} alerts=${results.service_alerts||0}`, 'MEDIUM');
        updateDemoOverlay('Agent cycle completed', `<div style="font-size:12px;">Inventory Decisions: ${results.inventory_decisions||0}<br>Transport Decisions: ${results.transport_decisions||0}<br>Service Alerts: ${results.service_alerts||0}</div>`, `Agent cycle done`);
        setStatus('‚úì Agent cycle complete','green');
        // refresh data after slight delay
        setTimeout(loadData, 500);
    } catch(err){
        console.error('runAgentCycle error', err);
        setStatus('Agent cycle failed','red');
    }
}

/* --- compute forecast & simple plan (client-side heuristic) --- */
async function computeForecastAndPlan(){
    try {
        // use nodes already loaded in DOM to estimate
        const nodeEls = document.querySelectorAll('[data-node-id]');
        let forecastHtml = '';
        let planHtml = '';
        let anyCritical = false;
        nodeEls.forEach(el=>{
            const id = el.getAttribute('data-node-id');
            const currText = el.querySelector('div > div:nth-child(2) div') ? el.querySelector('div > div:nth-child(2) div').innerText : '';
            // safer: parse the number from the content we generated earlier (first numeric occurrence)
            const numMatch = el.innerText.match(/([\d,]{1,})/);
            const currentInv = numMatch ? parseInt(numMatch[1].replace(/,/g,'')) : 0;
            const capMatch = el.innerText.match(/\/\s*([\d,]{1,})/);
            const cap = capMatch ? parseInt(capMatch[1].replace(/,/g,'')) : 1;
            // heuristic avg demand by type: store=200, dc=100, wh=120 (client-side fallback)
            const typeText = el.querySelector('.muted') ? el.querySelector('.muted').innerText : '';
            let avgDemand = 100;
            if(typeText && typeText.toUpperCase().includes('STORE')) avgDemand = 200;
            else if(typeText && typeText.toUpperCase().includes('DC')) avgDemand = 120;
            else if(typeText && typeText.toUpperCase().includes('WH')) avgDemand = 120;
            // days until stockout
            const days = Math.ceil(currentInv / Math.max(1, avgDemand));
            if(days <= 2){
                anyCritical = true;
                forecastHtml += `<div style="font-weight:700; margin-bottom:6px;">${el.querySelector('div').innerText.trim()} ‚Äî stockout in ~${days} cycles</div>`;
                planHtml += `<div style="margin-bottom:6px;">Plan: Consider transfer or reorder to keep service level. Recommended qty: ${Math.max(50, Math.round(cap*0.15))}</div>`;
            }
        });
        if(!forecastHtml) forecastHtml = `<div>No imminent shortages detected (client-side forecast)</div>`;
        $('forecastText').innerHTML = forecastHtml;
        $('planText').innerHTML = planHtml;
        // visually emphasize alerts panel if critical
        if(anyCritical){
            $('alertsPanel').style.border = '1px solid rgba(239,68,68,0.14)';
            $('alertsPanel').style.boxShadow = '0 18px 48px rgba(239,68,68,0.08)';
        } else {
            $('alertsPanel').style.border = '1px solid rgba(8,145,255,0.06)';
            $('alertsPanel').style.boxShadow = '0 12px 40px rgba(3,7,18,0.06)';
        }
    } catch(e){
        console.error('forecast error',e);
    }
}

/* --- update overlay small status blocks --- */
function updateDemoOverlay(status, nodeInfo, activity){
    if($('demoStatus') && status) $('demoStatus').textContent = status;
    if($('demoNode') && nodeInfo) $('demoNode').innerHTML = nodeInfo;
    if(activity && $('demoActivity')){
        const time = new Date().toLocaleTimeString();
        $('demoActivity').innerHTML = `<div style="font-weight:700">${time}</div><div class="muted">${activity}</div>` + $('demoActivity').innerHTML;
        // keep only last 6
        const actEl = $('demoActivity');
        while(actEl.children.length > 6) actEl.removeChild(actEl.lastChild);
    }
}

/* --- Add activity to stream --- */
function addActivity(agent, action, urgency='MEDIUM'){
    const stream = $('activityStream');
    const time = new Date().toLocaleTimeString();
    const item = document.createElement('div');
    item.style.borderLeft = '4px solid rgba(2,6,23,0.06)';
    item.style.padding = '8px';
    item.style.marginBottom = '8px';
    item.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:8px; align-items:center;">
            <div style="font-size:18px;">ü§ñ</div>
            <div>
                <div style="font-weight:800">${agent}</div>
                <div class="muted" style="font-size:13px;">${action}</div>
            </div>
        </div>
        <div class="muted" style="font-size:12px;">${time}</div>
    </div>`;
    stream.insertBefore(item, stream.firstChild);
    // keep last 12
    while(stream.children.length > 12) stream.removeChild(stream.lastChild);
}

/* --- live mode (auto simulate transactions & occasionally run agent cycle) --- */
async function startLiveMode(){
    if(isLiveMode) return;
    isLiveMode = true;
    setStatus('üî¥ LIVE MODE ACTIVE','red');
    openOverlay();
    await loadData();
    liveInterval = setInterval(async ()=>{
        if(!isLiveMode) return;
        await simulateTransaction();
        if(Math.random() > 0.7) await runAgentCycle();
    }, 3200);
}
function stopLiveMode(){ isLiveMode = false; if(liveInterval) clearInterval(liveInterval); setStatus('LIVE Mode stopped','gray'); }

/* --- initialize UI & first data load --- */
document.addEventListener('DOMContentLoaded', ()=>{
    loadData();
    updateTimestamp();
    // initial chart empty
    renderTransportChart(null);
    // hide overlay initially
    $('demoOverlay').style.display = 'none';
    // show alerts panel hidden until demo/open but we'll keep it visible per option A only when overlay opened
    $('alertsPanel').style.display = 'none';
});

/* --- small keyboard helpers for demo testing --- */
document.addEventListener('keydown', (e)=>{
    if(e.key === 'ArrowRight') nextSlide();
    if(e.key === 'ArrowLeft') prevSlide();
});
</script>
</body>
</html>
